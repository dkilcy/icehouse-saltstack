###
# Install the Compute agent for Telemetry
# http://docs.openstack.org/icehouse/install-guide/install/yum/content/ceilometer-install-nova.html
# Icehouse
# Author: David Kilcy
###

{% set controller = salt['pillar.get']('openstack:controller') %}
{% set admin_token = salt['pillar.get']('openstack:ADMIN_TOKEN') %}

{% set ceilometer_pass = salt['pillar.get']('openstack:CEILOMETER_PASS') %}
{% set ceilometer_dbpass = salt['pillar.get']('openstack:CEILOMETER_DBPASS') %}
{% set ceilometer_token = salt['pillar.get']('openstack:CEILOMETER_PASS') %}

{% set mongodb_host = salt['pillar.get']('openstack:controller') %}

###
# 1. Install the Telemetry service on the compute node:
###

openstack_ceilometer_compute:
  pkg.installed:
    - name: openstack-ceilometer-compute

python_ceilometerclient:
  pkg.installed:
    - name: python-ceilometerclient

python_pecan:
  pkg.installed:
    - name: python-pecan

###
# 2. Set the following options in the /etc/nova/nova.conf file: 
###

ceilometer_compute_conf_1:
  openstack_config.present:
    - filename: /etc/nova/nova.conf
    - section: DEFAULT
    - parameter: instance_usage_audit
    - value: 'True'

ceilometer_controller_conf_2:
  openstack_config.present:
    - filename: /etc/ceilometer/ceilometer.conf
    - section: keystone_authtoken
    - parameter: admin_user
    - value: ceilometer

ceilometer_controller_conf_3:
  openstack_config.present:
    - filename: /etc/ceilometer/ceilometer.conf
    - section: keystone_authtoken
    - parameter: admin_tenant_name
    - value: service

ceilometer_controller_conf_4:
  openstack_config.present:
    - filename: /etc/ceilometer/ceilometer.conf
    - section: keystone_authtoken
    - parameter: auth_protocol
    - value: http

ceilometer_controller_conf_5:
  openstack_config.present:
    - filename: /etc/ceilometer/ceilometer.conf
    - section: keystone_authtoken
    - parameter: auth_uri
    - value: http://{{ controller }}:5000

ceilometer_controller_conf_6:
  openstack_config.present:
    - filename: /etc/ceilometer/ceilometer.conf
    - section: keystone_authtoken
    - parameter: admin_password
    - value: {{ ceilometer_pass }}

ceilometer_controller_conf_7:
  openstack_config.present:
    - filename: /etc/ceilometer/ceilometer.conf
    - section: service_credentials
    - parameter: os_auth_url
    - value: http://{{ controller }}:5000/v2.0

ceilometer_controller_conf_8:
  openstack_config.present:
    - filename: /etc/ceilometer/ceilometer.conf
    - section: service_credentials
    - parameter: os_username
    - value: ceilometer

ceilometer_controller_conf_9:
  openstack_config.present:
    - filename: /etc/ceilometer/ceilometer.conf
    - section: service_credentials
    - parameter: os_tenant_name
    - value: service

ceilometer_controller_conf_10:
  openstack_config.present:
    - filename: /etc/ceilometer/ceilometer.conf
    - section: service_credentials
    - parameter: os_password
    - value: {{ ceilometer_pass }}

###
# 12. Register the Telemetry service with the Identity Service so that other OpenStack services can locate it.
###

ceilometer_identity_service:
  keystone.service_present:
    - name: ceilometer
    - service_type: metering
    - description: 'OpenStack Telemetry'
    - connection_token: {{ admin_token }}

ceilometer_api_endpoint:
  keystone.endpoint_present:
    - name: ceilometer
    - publicurl: http://{{ controller }}:8777
    - internalurl: http://{{ controller }}:8777
    - adminurl: http://{{ controller }}:8777
#    - region: regionOne
    - connection_token: {{ admin_token }}

###
# 13. Start the openstack-ceilometer-api, openstack-ceilometer-central, openstack-ceilometer-collector and
#     services and configure them to start when the system boots:
###

openstack_ceilometer_api_service:
  service.running:
    - name: openstack-ceilometer-api

openstack_ceilometer_collector_service:
  service.running:
    - name: openstack-ceilometer-collector

openstack_ceilometer_notification_service:
  service.running:
    - name: openstack-ceilometer-notification

openstack_ceilometer_central_service:
  service.running:
    - name: openstack-ceilometer-central

openstack_ceilometer_alarm_evaluator_service:
  service.running:
    - name: openstack-ceilometer-alarm-evaluator

openstack_ceilometer_alarm_notifier_service:
  service.running:
    - name: openstack-ceilometer-alarm-notifier


openstack_ceilometer_api_service_enabled_on_boot:
  service.running:
    - name: openstack-ceilometer-api

openstack_ceilometer_collector_service_enabled_on_boot:
  service.running:
    - name: openstack-ceilometer-collector

openstack_ceilometer_notification_service_enabled_on_boot:
  service.running:
    - name: openstack-ceilometer-notification

openstack_ceilometer_central_service_enabled_on_boot:
  service.running:
    - name: openstack-ceilometer-central

openstack_ceilometer_alarm_evaluator_service_enabled_on_boot:
  service.running:
    - name: openstack-ceilometer-alarm-evaluator

openstack_ceilometer_alarm_notifier_service_enabled_on_boot:
  service.running:
    - name: openstack-ceilometer-alarm-notifier


